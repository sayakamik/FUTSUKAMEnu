<div class="container">
  <div class="row">
    <div class="col-md-11">
      <% if @recipe.errors.any? %>
        <%= @recipe.errors.count %>件のエラーが発生しました
        <ul>
          <% @recipe.errors.full_messages.each do |message| %>
            <li><%= message %></li>
          <% end %>
        </ul>
      <% end %>
      <div class="row">
        <h2 class="title"><b>レシピを投稿しよう</b></h2>
      </div>

      <%= form_with model: @recipe, local:true do |f| %>
        <div class="form-group row">
          <div class="col-md-3">
         　　 <%= image_tag 'no_image.jpg', alt: 'Image', class: "img-fluid", width: 300, height: 'auto' %>
         　　 <%= f.file_field :menu_image, accept: 'image/*', size: 30 %>
          </div>

          <div class="col-md-9 col-sm-12">
            <!--レシピ名、説明文-->
            <div class="cooking-title"><b>レシピについて</b></div>
              <%= f.text_field :name, autofocus: true, placeholder: "メニュー名(50文字以内)" , class: "form-control" %>&ensp;
              <%= f.text_area :description, placeholder: "説明、メッセージ(100字以内)", class: "form-control" %>

            <!--1日目メニュー入力、投稿（Javascript、一部modelに記載)-->
            <div class="cooking-title"><b>アレンジ前1日目メニュー</b><br>＊保存後は変更できません。注意して登録して下さい。</div>
              <%= f.text_field :original_menu_name, autofocus: true, placeholder: "1日目メニュー(15文字以内)＊一度保存すると変更不可。",
                  id: "originalMenuField",
                  class: "form-control",
                  data: {
                    json: @original_menus_json
                  } %>
            <div id="originalMenuList"></div>
            <%= f.hidden_field :original_menu_id, id: "originalMenuId", value: @recipe.original_menu_id %>

           <!--1日目メニュー登録について-->
            <script>
              document.addEventListener('turbolinks:load', function() {
                //きっかけがkeyup（指を離した）時に,以降コードを実行(すべての情報がe（引数）に入る
                $("#originalMenuField").on("keyup", (e) => {
                  // 変更できない変数:const JSON.perseでHTML文字情報をJSコードに変換(""がタグコードになったりするため)
                  // .target:HTML部分を取得 dataset:dataタグ json:dataタグの右側（任意で命名）
                  const data = JSON.parse(e.target.dataset.json)
                  // HTMLの値（文字情報）を取得
                  const target = e.target.value
                  // 上記の情報で、条件が当てはまるものを選択(ruby:select)して表示
                  const result = data.filter((o) =>
                    o.name.includes(target) && target.length > 0
                  )
                  // $はjqueryのオブジェクト
                  const originalMenuList = $("#originalMenuList")
                  // 下層のタグを消す（JSは元の状態を記憶しておらず、引っ張った情報は自動で消えないため中の要素だけ空にする）
                  originalMenuList.empty()
                  // 配列に対しruby:eachで引数o
                  result.forEach((o) => {
                    // データを下に追加する``で改行、埋め込みが使用可能
                    const appendData = originalMenuList.append(`
                     <div class="badge badge-secondary" data-id=${o.id}>${o.name}</div>
                    `)
                    // JSは上書き更新できないため、過去の同じタグのeventをOFFにする（今回の場合は上記の）
                    appendData.off();
                    // appendDataにclickイベント追加
                    appendData.on("click", (e) => {
                      // タグ内の文字を取得
                      const name = e.target.innerHTML
                      // データからidを取得
                      const id = e.target.dataset.id
                      // 候補から選ばれた名前、idをフォームに入れる（idはhiddenfield)
                      $("#originalMenuField").val(name)
                      $("#originalMenuId").val(id)
                      // 選んだら必要ないので削除
                      originalMenuList.empty()
                    })
                  })
                })
              });
            </script>

            <!--タグ-->
            <div class="form-group">
              <div class="cooking-title"><b>関連タグ(カンマ『,』で複数個登録できます)</b></div>
                <section class="tag">
                  <%= f.text_field :tag_name, value: @tag_list, placeholder: "タグ", class: 'form-control book_tag_name' %>
                </section>
            </div>
          </div>
        </div>

      <!--材料フォーム、手順フォーム（Javascript)-->
      <%#= render 'ingredient_procedure', f: ingredient_field, f: procedure_field %>

      <!--材料フォーム（Javascript)-->
      <div class="cooking-title"><b>材料</b></div>
        <section class="ingredient-form">
          <!-- 材料、分量フォームの隠し要素テンプレート、display: noneを指定しているため表示はされない -->
          <div id="ingredient-fields-template" style="display: none;">
            <!-- 新しいIngredientオブジェクトを作成, 新たに追加されるフォームに一意なインデックスを付与 -->
            <%= f.fields_for :ingredients, Ingredient.new, child_index: "new_ingredient" do |ingredient_field| %>
              <%= render 'public/recipes/ingredient_field', f: ingredient_field %>
            <% end %>
          </div>
          <!--隠し要素テンプレート終わり-->
          <!--すでにデータベースに保存されているか、または新しくユーザーが追加した「材料」に関する情報を表示するためのフォーム-->
          <%= f.fields_for :ingredients do |ingredient_field| %>
            <%= render 'public/recipes/ingredient_field', f: ingredient_field %>
          <% end %>
          <div id="ingredients"></div>
        　　<div>
              <button type="button" id="add-ingredient" class="btn btn-light custom-add">材料を追加</button>
            </div>
      　</section>

      <!--手順フォーム（Javascript)-->
      <div class="cooking-title"><b>作り方（必須）＊写真は必須ではありません。</div>
        <section class="procedure">
          　<!--作り方フォームの隠し要素テンプレート-->
            <div id="procedure-fields-template" style="display: none;">
              <!--新しいRecipeStepオブジェクトを作成-->
              <%= f.fields_for :procedures, Procedure.new, child_index: "new_procedure" do |procedure_field| %>
                <%= render 'public/recipes/procedure_field', f: procedure_field %>
              <% end %>
            </div>
            <!--すでにデータベースに存在するか、または新しく追加された「作り方」ステップを表示するフォーム-->
            <%= f.fields_for :procedures do |procedure_field| %>
              <%= render 'public/recipes/procedure_field', f: procedure_field %>
            <% end %>
            <div id="procedures"></div>
              <div>
                 <button type="button" id="add-procedure" class="btn btn-light custom-add mb-4">作り方を追加</button>
              </div>
        </section>

      <!--材料、手順のJavascript-->
      <script>
           // DOMContentLoaded文書のロード、DOMが完全に読み込まれた後に以下のコードが実行される
          document.addEventListener('turbolinks:load', function() {
            // "add-ingredient" IDを持つHTML要素（ボタン）を取得、「材料を追加」ボタンにクリックイベントを追加
            document.getElementById("add-ingredient").addEventListener("click", function() {
              // "ingredient-fields-template"というIDを持つdiv要素の内部HTML（隠しテンプレート）を取得
              var content = document.getElementById("ingredient-fields-template").innerHTML;
              var uniqueId = new Date().getTime();
              // replace: テンプレート内のプレースホルダーを一意なIDで置き換え
              content = content.replace(/new_ingredient/g, uniqueId);
              // 新しい材料フォームをDOMに追加
              document.getElementById("ingredients").insertAdjacentHTML('beforeend', content);
            });
          });
            // 作り方フォーム追加
            document.addEventListener('turbolinks:load', () => {
              document.querySelector('#add-procedure').addEventListener('click', () => {
                let content = document.getElementById('procedure-fields-template').innerHTML;
                let uniqueId = new Date().getTime();
                content = content.replace(/new_procedure/g, uniqueId);
                document.getElementById('procedures').insertAdjacentHTML('beforeend', content);
              });
            });
      </script>

      <div class="row mt-4 pb-5">
        <div class="form-inline mx-auto">
            <%= f.submit 'レシピを公開', :name => 'post', class: 'mr-5 btn btn-light custom-light' %>
            <%= f.submit '下書きに保存', :name => 'draft', class: 'ml-5 btn btn-light custom-lightblue' %>
        </div>
      </div>
      <% end %>
    </div>
  </div>
</div>

